# docker-compose.test.yml
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: test_db
    ports:
      - '5432:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U test']
      interval: 1s
      timeout: 5s
      retries: 5

  stripe-mock:
    image: stripe/stripe-mock:v0.197.0
    environment:
      # Test key for stripe-mock healthcheck (not a real secret, just satisfies format requirement)
      STRIPE_MOCK_API_KEY: sk_test_healthcheck
    ports:
      - '12111:12111'
      - '12112:12112'
    healthcheck:
      # Use $$ to escape the $ so docker-compose passes it through to the container shell
      test: ['CMD-SHELL', 'curl -fsS -H "Authorization: Bearer $$STRIPE_MOCK_API_KEY" http://localhost:12111/v1/customers > /dev/null']
      interval: 2s
      timeout: 5s
      retries: 5

