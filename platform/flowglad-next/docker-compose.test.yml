# docker-compose.test.yml
#
# LOCAL DEVELOPMENT ONLY
# CI uses GitHub Actions services (defined in workflow files) instead.
# Keep service versions in sync with .github/workflows/flowglad-next-sharded-unit-tests.yml
#
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: test_db
    ports:
      - '5432:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U test']
      interval: 1s
      timeout: 5s
      retries: 5

  stripe-mock:
    image: stripe/stripe-mock:v0.197.0
    ports:
      - '12111:12111'
      - '12112:12112'
    healthcheck:
      # Use a test API key directly - this is not a real secret, just satisfies stripe-mock's format requirement
      # Note: stripe-mock image doesn't have curl, but does have wget
      test: ['CMD-SHELL', 'wget -q -O /dev/null --header="Authorization: Bearer sk_test_healthcheck" http://localhost:12111/v1/customers'] # gitleaks:allow
      interval: 2s
      timeout: 5s
      retries: 5

  flowglad-mock-server:
    build:
      context: ../../packages/mock-server
      dockerfile: Dockerfile
    ports:
      - '9001:9001'  # Svix
      - '9002:9002'  # Unkey
      - '9003:9003'  # Trigger
      - '9004:9004'  # Redis
      - '9005:9005'  # Resend
      - '9006:9006'  # Cloudflare R2
    healthcheck:
      test: ['CMD-SHELL', 'curl -fsS http://localhost:9001/health > /dev/null']
      interval: 2s
      timeout: 5s
      retries: 5

