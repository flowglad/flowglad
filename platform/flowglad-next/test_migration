-- Test data for migration 0251_hot_sally_floyd.sql
-- This creates the necessary data structure to test the migration

-- 1. Insert a country (required for organizations)
-- Note: countries table does NOT have livemode column
INSERT INTO "countries" ("id", "code", "name", "created_at", "updated_at", "created_by_commit", "updated_by_commit", "position")
SELECT 'country_test_001', 'US', 'United States', NOW(), NOW(), 'test', 'test', 1
WHERE NOT EXISTS (SELECT 1 FROM "countries" WHERE "id" = 'country_test_001');

-- 2. Insert an organization
-- Note: organizations table does NOT have livemode column
INSERT INTO "organizations" (
  "id", "name", "country_id", "default_currency", "fee_percentage", 
  "security_salt", "created_at", "updated_at", "created_by_commit", "updated_by_commit", "position"
)
SELECT 
  'org_test_001', 'Test Organization', 'country_test_001', 'USD', '0.65',
  'test_salt_12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678',
  NOW(), NOW(), 'test', 'test', 1
WHERE NOT EXISTS (SELECT 1 FROM "organizations" WHERE "id" = 'org_test_001');

-- 3. Insert a pricing model (required for features)
INSERT INTO "pricing_models" (
  "id", "organization_id", "name", "is_default",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 
  'pricing_model_test_001', 'org_test_001', 'Default Pricing Model', true,
  NOW(), NOW(), 'test', 'test', false, 1
WHERE NOT EXISTS (SELECT 1 FROM "pricing_models" WHERE "id" = 'pricing_model_test_001');

-- 4. Insert a customer
INSERT INTO "customers" (
  "id", "organization_id", "email", "name", "external_id",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 
  'cust_test_001', 'org_test_001', 'test@example.com', 'Test Customer', 'ext_cust_001',
  NOW(), NOW(), 'test', 'test', false, 1
WHERE NOT EXISTS (SELECT 1 FROM "customers" WHERE "id" = 'cust_test_001');

-- 5. Insert subscriptions (we'll create 2 to test multiple subscriptions)
INSERT INTO "subscriptions" (
  "id", "customer_id", "organization_id", "status", "start_date", "renews",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'sub_test_001', 'cust_test_001', 'org_test_001', 'active', NOW(), true,
       NOW(), NOW(), 'test', 'test', false, 1
WHERE NOT EXISTS (SELECT 1 FROM "subscriptions" WHERE "id" = 'sub_test_001');

INSERT INTO "subscriptions" (
  "id", "customer_id", "organization_id", "status", "start_date", "renews",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'sub_test_002', 'cust_test_001', 'org_test_001', 'active', NOW(), true,
       NOW(), NOW(), 'test', 'test', false, 2
WHERE NOT EXISTS (SELECT 1 FROM "subscriptions" WHERE "id" = 'sub_test_002');

-- 6. Insert features (required for subscription_item_features)
INSERT INTO "features" (
  "id", "organization_id", "pricing_model_id", "type", "slug", "name", "description", "active",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'feature_test_001', 'org_test_001', 'pricing_model_test_001', 'toggle', 'premium-support', 'Premium Support', 'Premium customer support feature', true,
       NOW(), NOW(), 'test', 'test', false, 1
WHERE NOT EXISTS (SELECT 1 FROM "features" WHERE "id" = 'feature_test_001');

INSERT INTO "features" (
  "id", "organization_id", "pricing_model_id", "type", "slug", "name", "description", "active",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'feature_test_002', 'org_test_001', 'pricing_model_test_001', 'toggle', 'advanced-analytics', 'Advanced Analytics', 'Advanced analytics feature', true,
       NOW(), NOW(), 'test', 'test', false, 2
WHERE NOT EXISTS (SELECT 1 FROM "features" WHERE "id" = 'feature_test_002');

INSERT INTO "features" (
  "id", "organization_id", "pricing_model_id", "type", "slug", "name", "description", "active",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'feature_test_003', 'org_test_001', 'pricing_model_test_001', 'toggle', 'api-access', 'API Access', 'API access feature', true,
       NOW(), NOW(), 'test', 'test', false, 3
WHERE NOT EXISTS (SELECT 1 FROM "features" WHERE "id" = 'feature_test_003');

-- 6.5. Insert products (required for prices)
INSERT INTO "products" (
  "id", "organization_id", "pricing_model_id", "name", "active", "default",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'prod_test_001', 'org_test_001', 'pricing_model_test_001', 'Test Product 1', true, false,
       NOW(), NOW(), 'test', 'test', false, 1
WHERE NOT EXISTS (SELECT 1 FROM "products" WHERE "id" = 'prod_test_001');

INSERT INTO "products" (
  "id", "organization_id", "pricing_model_id", "name", "active", "default",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'prod_test_002', 'org_test_001', 'pricing_model_test_001', 'Test Product 2', true, false,
       NOW(), NOW(), 'test', 'test', false, 2
WHERE NOT EXISTS (SELECT 1 FROM "products" WHERE "id" = 'prod_test_002');

-- 6.6. Insert prices (required for subscription_items)
INSERT INTO "prices" (
  "id", "product_id", "type", "unit_price", "currency", "is_default", "active",
  "interval_unit", "intervalCount",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'price_test_001', 'prod_test_001', 'subscription', 1000, 'USD', true, true,
       'month', 1,
       NOW(), NOW(), 'test', 'test', false, 1
WHERE NOT EXISTS (SELECT 1 FROM "prices" WHERE "id" = 'price_test_001');

INSERT INTO "prices" (
  "id", "product_id", "type", "unit_price", "currency", "is_default", "active",
  "interval_unit", "intervalCount",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'price_test_002', 'prod_test_002', 'subscription', 2000, 'USD', true, true,
       'month', 1,
       NOW(), NOW(), 'test', 'test', false, 2
WHERE NOT EXISTS (SELECT 1 FROM "prices" WHERE "id" = 'price_test_002');

-- 7. Insert regular subscription items (with price_id, BEFORE migration - no manually_created column yet)
-- These will be the items that manual features are currently pointing to
-- NOTE: Before migration 0251, subscription_items does NOT have manually_created column
--       and price_id is NOT NULL (required)
INSERT INTO "subscription_items" (
  "id", "subscription_id", "name", "price_id", "unit_price", "quantity", 
  "added_date", "type",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'si_test_001', 'sub_test_001', 'Basic Plan Item', 'price_test_001', 1000, 1,
       NOW(), 'static',
       NOW(), NOW(), 'test', 'test', false, 1
WHERE NOT EXISTS (SELECT 1 FROM "subscription_items" WHERE "id" = 'si_test_001');

INSERT INTO "subscription_items" (
  "id", "subscription_id", "name", "price_id", "unit_price", "quantity", 
  "added_date", "type",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'si_test_002', 'sub_test_002', 'Pro Plan Item', 'price_test_002', 2000, 1,
       NOW(), 'static',
       NOW(), NOW(), 'test', 'test', false, 2
WHERE NOT EXISTS (SELECT 1 FROM "subscription_items" WHERE "id" = 'si_test_002');

-- 8. Insert subscription_item_features with manually_created = true
-- These are the features that should be migrated to point to a new manual subscription item
INSERT INTO "subscription_item_features" (
  "id", "subscription_item_id", "feature_id", "type", "manually_created",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'sif_test_001', 'si_test_001', 'feature_test_001', 'toggle', true,
       NOW(), NOW(), 'test', 'test', false, 1
WHERE NOT EXISTS (SELECT 1 FROM "subscription_item_features" WHERE "id" = 'sif_test_001');

INSERT INTO "subscription_item_features" (
  "id", "subscription_item_id", "feature_id", "type", "manually_created",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'sif_test_002', 'si_test_001', 'feature_test_002', 'toggle', true,
       NOW(), NOW(), 'test', 'test', false, 2
WHERE NOT EXISTS (SELECT 1 FROM "subscription_item_features" WHERE "id" = 'sif_test_002');

INSERT INTO "subscription_item_features" (
  "id", "subscription_item_id", "feature_id", "type", "manually_created",
  "created_at", "updated_at", "created_by_commit", "updated_by_commit", "livemode", "position"
)
SELECT 'sif_test_003', 'si_test_002', 'feature_test_003', 'toggle', true,
       NOW(), NOW(), 'test', 'test', false, 3
WHERE NOT EXISTS (SELECT 1 FROM "subscription_item_features" WHERE "id" = 'sif_test_003');

-- ============================================================
-- VERIFICATION QUERIES - Run these before and after migration
-- ============================================================

-- BEFORE MIGRATION: Check state of manual features pointing to regular items
-- This shows the problem: manual features are attached to regular subscription items
-- NOTE: Run this BEFORE running migration 0251 (manually_created column doesn't exist on subscription_items yet)
SELECT 
  'BEFORE MIGRATION' as state,
  si.id as subscription_item_id,
  si.subscription_id,
  si.price_id,
  si.name as item_name,
  sif.id as feature_id,
  sif.manually_created as feature_manually_created,
  f.name as feature_name
FROM subscription_items si
INNER JOIN subscription_item_features sif ON sif.subscription_item_id = si.id
INNER JOIN features f ON f.id = sif.feature_id
WHERE sif.manually_created = true
ORDER BY si.subscription_id, sif.id;

-- AFTER MIGRATION: Check that manual features now point to manual items
-- This should show manual features pointing to new manual subscription items
SELECT 
  'AFTER MIGRATION' as state,
  si.id as subscription_item_id,
  si.subscription_id,
  si.price_id,
  si.name as item_name,
  si.manually_created as item_manually_created,
  si.unit_price,
  sif.id as feature_id,
  sif.manually_created as feature_manually_created,
  f.name as feature_name
FROM subscription_items si
INNER JOIN subscription_item_features sif ON sif.subscription_item_id = si.id
INNER JOIN features f ON f.id = sif.feature_id
WHERE sif.manually_created = true
ORDER BY si.subscription_id, sif.id;

-- Check all subscription items after migration (should see new manual items)
SELECT 
  si.id,
  si.subscription_id,
  si.name,
  si.price_id,
  si.manually_created,
  si.unit_price,
  si.quantity,
  COUNT(sif.id) as feature_count
FROM subscription_items si
LEFT JOIN subscription_item_features sif ON sif.subscription_item_id = si.id
WHERE si.subscription_id IN ('sub_test_001', 'sub_test_002')
GROUP BY si.id, si.subscription_id, si.name, si.price_id, si.manually_created, si.unit_price, si.quantity
ORDER BY si.subscription_id, si.manually_created, si.id;