---
title: Generation-Based Subscription
description: Learn how to implement generation-based subscription in TanStack Start with Flowglad.
---

A hybrid billing model combining subscriptions with usage credits and one-time top-ups. Common for AI generation platforms.

<Note>
View the complete source code on [GitHub](https://github.com/flowglad/examples/tree/main/tanstack-start/generation-based-subscription).
</Note>

## Prerequisites

- Flowglad account with API key
- TanStack Start project with authentication (this example uses [Better Auth](https://better-auth.com))
- Node.js 21+ or Bun

## Project Structure

```
├── src/
│   ├── lib/
│   │   ├── flowglad.ts
│   │   └── billing-helpers.ts
│   └── routes/
│       ├── api/
│       │   └── usage-events.ts
│       ├── index.tsx
│       └── pricing.tsx
├── pricing.yaml
└── package.json
```

## Key Concepts

This pricing model combines three billing mechanisms:

1. **Subscription tiers** - Monthly plans at fixed prices (\$10, \$30, \$60/mo)
2. **Usage credit grants** - Each tier includes credits that renew each billing period (200, 360, 750 generations)
3. **One-time top-ups** - Customers can purchase additional credits when they run out

This model works well when you want predictable recurring revenue while giving customers flexibility to exceed their plan limits. Customers who find themselves consistently purchasing top-ups can choose to upgrade to a higher tier for better value.

## Implementation

### Pricing Configuration

The `pricing.yaml` file defines subscription tiers, credit allocations, and top-up products. See the [full configuration](https://github.com/flowglad/examples/blob/main/tanstack-start/generation-based-subscription/pricing.yaml) in the repository.

<img 
  className="block dark:hidden" 
  src="/images/example-diagrams/light/generation-based-diagram.svg" 
  alt="Pricing model diagram showing usage meters, subscription tiers, and top-ups"
/>

<img 
  className="hidden dark:block" 
  src="/images/example-diagrams/dark/generation-based-diagram.svg" 
  alt="Pricing model diagram showing usage meters, subscription tiers, and top-ups"
/>

The key distinction in `pricing.yaml` is `renewalFrequency`: use `"every_billing_period"` for subscription credits that reset monthly, and `"once"` for top-up credits that are consumed permanently.

### Checking Usage Balance

Use `checkUsageBalance` to display remaining credits and gate access to generation features.

```tsx src/routes/index.tsx
const billing = useBilling();
const balance = billing.checkUsageBalance('fast_generations');

// balance.availableBalance - credits remaining
```

The balance includes both subscription credits and any purchased top-ups. Flowglad automatically draws from credits when you register a usage event.

### Recording Usage

When a customer generates content, record the usage event server-side. This decrements their credit balance.

```ts src/routes/api/usage-events.ts
const flowgladServer = flowglad(userId);
const billing = await flowgladServer.getBilling();
const subscription = billing.currentSubscriptions?.[0];

await flowgladServer.createUsageEvent({
  subscriptionId: subscription.id,
  priceSlug: 'fast_generation_usage',
  amount: 1,
  transactionId: 'unique-id-for-idempotency',
});
```

The `transactionId` parameter ensures idempotency (generated and sent from the client). If the same event is sent twice (e.g., due to a retry), it won't double-count usage.

### Checking Feature Access

Toggle features let you differentiate plans beyond just credit amounts. Use `checkFeatureAccess` to check if a user has access to gated premium features.

```tsx src/routes/index.tsx
const hasRelaxMode = billing.checkFeatureAccess('unlimited_relaxed_images');
```

This returns `true` if the customer's current subscription includes the feature, `false` otherwise.

### Purchasing Top-Up Credits

When customers run low on credits, let them purchase additional credits without changing their subscription.

```tsx src/routes/index.tsx
const price = billing.getPrice('fast_generation_top_up');

await billing.createCheckoutSession({
  priceId: price.id,
  successUrl: window.location.href,
  cancelUrl: window.location.href,
  quantity: 1,
  autoRedirect: true,
});
```

This opens a checkout for the top-up product. On successful payment, the credits are immediately added to the customer's balance.

## Next Steps

<CardGroup cols={2}>
  <Card title="View Source Code" icon="github" href="https://github.com/flowglad/examples/tree/main/tanstack-start/generation-based-subscription">
    Browse the complete example implementation
  </Card>
  <Card title="TanStack Start SDK" icon="book" href="/sdks/tanstack-start">
    Full TanStack Start SDK documentation
  </Card>
  <Card title="Feature Access & Usage" icon="gauge" href="/sdks/feature-access-usage">
    Learn more about usage-based billing
  </Card>
  <Card title="Webhooks" icon="webhook" href="/features/webhooks">
    Handle billing events server-side
  </Card>
</CardGroup>