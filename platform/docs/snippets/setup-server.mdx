## Installation

<CodeGroup>

```bash npm
npm install @flowglad/server
```

```bash yarn
yarn add @flowglad/server
```

```bash bun
bun add @flowglad/server
```

</CodeGroup>

## Quick Start

### 1. Set Up Environment Variables

```bash .env
FLOWGLAD_SECRET_KEY="sk_test_..."
```

### 2. Create a FlowgladServer Factory Function

<CodeGroup>

```ts Generic
import { FlowgladServer } from '@flowglad/server'

export const flowglad = (customerExternalId: string) => {
  // customerExternalId is the ID from YOUR app's database, NOT Flowglad's customer ID
  return new FlowgladServer({
    customerExternalId,
    getCustomerDetails: async (customerExternalId) => {
      // Fetch customer details from YOUR database using YOUR app's ID
      const user = await db.users.findOne({ id: customerExternalId })
      if (!user) {
        throw new Error('Customer not found')
      }
      return {
        email: user.email,
        name: user.name,
      }
    },
  })
}

// Usage:
// Pass YOUR app's user/organization ID, not Flowglad's customer ID
const billing = await flowglad(userId).getBilling()
```

```ts Example: Better Auth
import { FlowgladServer } from '@flowglad/server'
import { auth } from '@/utils/auth'

export const flowglad = (customerExternalId: string) => {
  return new FlowgladServer({
    customerExternalId,
    getCustomerDetails: async (customerExternalId) => {
      const session = await auth.api.getSession()
      if (!session?.user) {
        throw new Error('User not authenticated')
      }
      return {
        email: session.user.email || '',
        name: session.user.name || ''
      }
    },
  })
}
```

```ts Example: Supabase Auth
import { FlowgladServer } from '@flowglad/server'
import { createClient } from '@/utils/supabase/server'

export const flowglad = (customerExternalId: string) => {
  return new FlowgladServer({
    customerExternalId,
    getCustomerDetails: async (customerExternalId) => {
      const supabase = await createClient()
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        throw new Error('User not authenticated')
      }
      return {
        email: user.email || '',
        name: user.user_metadata.name || user.email || ''
      }
    },
  })
}
```

```ts Example: B2B (Organization-based)
import { FlowgladServer } from '@flowglad/server'

export const flowglad = (organizationId: string) => {
  // For B2B apps: organizationId is ID from YOUR app's database
  return new FlowgladServer({
    customerExternalId: organizationId,
    getCustomerDetails: async (customerExternalId) => {
      // Fetch organization details from YOUR database using YOUR org ID
      const org = await db.organizations.findOne({ id: customerExternalId })
      if (!org) {
        throw new Error('Organization not found')
      }
      return {
        email: org.billingEmail || org.ownerEmail,
        name: org.name,
      }
    },
  })
}
```

</CodeGroup>

<Note>
**Important:** `customerExternalId` is the ID from **your app's database** (e.g., `user.id` or `organization.id`), **not** Flowglad's customer ID.

**B2C apps:** Pass `user.id` as `customerExternalId`  
**B2B apps:** Pass `organization.id` or `team.id` as `customerExternalId`
</Note>

### 3. Call Server Methods

```ts
// Fetch billing details (customers, subscriptions, invoices, etc.)
// Pass YOUR app's user/organization ID, not Flowglad's customer ID
const billing = await flowglad(userId).getBilling()

// Ensure the Flowglad customer exists
const customer = await flowglad(userId).findOrCreateCustomer()

// Create a hosted checkout session
const checkoutSession = await flowglad(userId).createCheckoutSession({
  priceSlug: 'pro_plan',
  successUrl: 'https://example.com/success',
  cancelUrl: 'https://example.com/cancel',
})

// Check feature access for gating premium functionality
const hasPremium = billing.checkFeatureAccess('premium_feature')

// Record metered usage with price (for billing)
await flowglad(userId).createUsageEvent({
  amount: 1,
  priceSlug: 'usage_price_slug',
  subscriptionId: 'subscription_id',
  transactionId: 'idempotency-key',
})

// Record metered usage without price (for tracking only)
await flowglad(userId).createUsageEvent({
  amount: 1,
  usageMeterSlug: 'api_calls',
  subscriptionId: 'subscription_id',
  transactionId: 'idempotency-key',
})
```


