---
title: 'Integrate by Prompt'
description: 'Integrate Flowglad using natural language'
---

<Info>
  Before proceeding, make sure you've [created a Flowglad
  account](https://app.flowglad.com/sign-up) and added your API keys
  to your environment.
</Info>

<Note>
    Flowglad has an MCP server! It can give your AI coding agents more context with the Flowglad docs. You can add it to your AI coding tool of choice by following the [MCP server documentation](/mcp-server).
</Note>

## 1. Install The Flowglad Package

<CodeGroup>

```bash bun
bun add @flowglad/nextjs
```

```bash yarn
yarn add @flowglad/nextjs
```

```bash npm
npm install @flowglad/nextjs
```

</CodeGroup>

## 2. Codebase Overview

Flowglad can create a custom integration prompt for each pricing model in your organization.

If you haven't already, you'll need to complete a codebase overview to give Flowglad context about your codebase. You'll be asked to complete this overview when creating a new organization or you can do it later in [settings](https://app.flowglad.com/settings).

Simply copy the overview prompt into your AI coding tool of choice and paste the output into the provided text area in Flowglad. 

## 3. One Shot Integration

To access a pricing model's custom integration prompt, go to your pricing model, click "More Options", click "Integrate", and you'll see the generated prompt.

You can then copy this prompt into your AI coding tool and it should be able to one shot the integration.

<Accordion title="Example Custom Prompt">
Here's an example custom prompt for the generation-based subscription pricing model template. 

The codebase overview for this prompt was done on a brand new Next.js app.

```mdx
## Prompt: Integrate Flowglad Billing Into a Next.js App

You are an expert TypeScript/Next.js engineer and Flowglad integrator.  

You are given a **startup-style Next.js project** that currently has **no real billing or payment processing** wired up (at most: mock pricing data, placeholder billing hooks, or hard-coded plans).

Your task is to **integrate Flowglad end‑to‑end** so that:

- Authenticated users have Flowglad customers.
- Plans and usage meters are driven by a Flowglad pricing model.
- Usage events are recorded via Flowglad.
- The features that customers can access are determined by reading from Flowglad what features a given customer has access to
- The UI (pricing page, dashboard, navbar) reflects real subscription and usage state.

Assume:

- The project uses **Next.js** (App Router in the `app/` directory structure).
- Authentication is handled with **BetterAuth** or a comparable session‑based system you can access from both server and client.
- The project may already have:
  - A pricing page.
  - A dashboard or home page.
  - Mock billing utilities (e.g. `lib/utils.ts`).

Your output should be **code changes only** (no commentary).

---

### 1. High-Level Objectives

- **Introduce Flowglad billing** into an otherwise billing‑agnostic Next.js app.
- **Wire Flowglad server-side** so it:
  - Authenticates the current user via your existing auth system (BetterAuth in this repo).
  - Resolves the Flowglad customer from the authenticated user (user.id).
  - When a customer is created in our app (user registration if B2C, organization/team if B2B), we create a Flowglad customer record based on the id we use for that customer in our app.
  - Exposes a Flowglad HTTP API surface via `/api/flowglad/[...path]` (or equivalent route pattern).
- **Wire Flowglad client-side** so React components:
  - Use `useBilling` from `@flowglad/nextjs` as the canonical billing source of truth.
  - Rely on `billing.loaded`, `billing.loadBilling`, `billing.errors`, `billing.pricingModel`, `billing.currentSubscriptions`, and helpers like `billing.checkUsageBalance`, `billing.checkFeatureAccess`, `billing.getPrice`, `billing.createCheckoutSession`, `billing.cancelSubscription`, `billing.reload`.
- **Connect a Flowglad pricing model** to:
  - Subscription plans.
  - Usage meters (`fast_generations`, `hd_video_minutes`).
  - Feature toggles (`general_commercial_terms`, `optional_credit_top_ups`, `unlimited_relaxed_images`, etc.).
  - Usage top-ups.
- **Keep the UI conceptually the same** (pricing page, plan selection, usage meters), but back it with real Flowglad data instead of mocks.

---

### 2. Package & Script Changes (`package.json`)

Update `package.json` to add the Flowglad SDK packages. Prefer using published versions (or local workspace links if you're in a monorepo).

- **Add Flowglad dependencies** under `dependencies`:

    "@flowglad/nextjs": "0.13.0"

Note: the Flowglad SDKs are currently for TypeScript only. The current latest version is 0.13.0.

{PACKAGE_SCRIPTS_CODE}

Do **not** remove unrelated scripts or dependencies; only add/adjust what's required for Flowglad.

---

### 4. Server-Side Flowglad Wiring (`lib/flowglad.ts`)

Create (or update) `lib/flowglad.ts` in the project to centralize server‑side Flowglad access:

    import { FlowgladServer } from '@flowglad/nextjs/server'

    export const flowglad = (customerExternalId: string) => {
      return new FlowgladServer({
        customerExternalId,
        getCustomerDetails: async (externalId) => {
          const user = await db.users.findOne({ id: externalId })
          if (!user) {
            throw new Error('Customer not found')
          }
          return {
            email: user.email,
            name: user.name,
          }
        },
      })
    }

Requirements:

- Use the project's existing auth system (BetterAuth).
- Map your authenticated user to Flowglad's `externalId`, `name`, and `email`.
- Throw if no session/auth so Flowglad routes are protected.
- For B2B apps, derive the organization/team ID from the request context.

---

### 5. Flowglad API Route (`app/api/flowglad/[...path]/route.ts`)

Expose Flowglad's HTTP API using a Next.js route handler:

    import { nextRouteHandler } from '@flowglad/nextjs/server'
    import { flowglad } from '@/lib/flowglad'

    export const { GET, POST } = nextRouteHandler({
      flowglad,
      getCustomerExternalId: async (req) => {
        const userId = await getUserIdFromRequest(req)
        if (!userId) {
          throw new Error('User not authenticated')
        }
        return userId
      },
    })

Make sure this route follows Next.js conventions for API routes.

---

### 6. React Provider Setup (`app/layout.tsx`)

    import { PropsWithChildren } from 'react'
    import { FlowgladProvider } from '@flowglad/nextjs'
    import { createClient } from '@/utils/supabase'

    export default async function RootLayout({
      children,
    }: PropsWithChildren) {
      const supabase = createClient();
      const {
        data: { user }
      } = await supabase.auth.getUser();
      return (
        <FlowgladProvider loadBilling={!!user}>
          {children}
        </FlowgladProvider>
      )
    }

---

### 7. Replace Local Billing Hook (If Present) With Flowglad `useBilling`

Scan the project for any **local billing hooks** or placeholder billing utilities. Typical examples:

- `lib/utils.ts` exporting `useBilling` and maybe helpers like `decrementUsageBalance`.

Replace those imports with Flowglad's `useBilling` hook:

    // before (template)
    import { useBilling } from 'lib/utils';

    // after (Flowglad)
    import { useBilling } from '@flowglad/nextjs';

Make the same change everywhere the old hook was used (pricing components, navbars, dashboards, etc.).

Then, **delete** the obsolete local billing implementation file(s) that only exist to support mock/local billing.

Preserve all **call sites** and their semantics. Flowglad's `useBilling` is intentionally shaped to make this mostly a drop‑in replacement:

---

### 8. Billing Helper Typescript (`lib/utils.ts`)

Introduce or update billing helpers to use Flowglad's shared types.

    import { PricingModel, Product } from '@flowglad/react'

    export function getPlanDetails(billing: PricingModel) {
      const products = billing.products.map((product) => {
        return {
          name: product.name,
          price: product.defaultPrice.unitPrice / 100,
          features: product.features,
        }
      });
      return products;
    }

These helpers let your UI easily:

- Discover usage meters and prices by slug.
- Compute total included credits per plan.
- Determine whether a plan is the default/free plan.

---

### 9. Usage Event API (`app/api/usage-events/route.ts`)

If the app tracks usage (e.g. API calls, compute time, storage, `fast_generations`), introduce or update an API route that records usage via Flowglad instead of a mock store.

- Path: `app/api/usage-events/route.ts`

    import { flowglad } from '@/lib/flowglad'

    export async function POST(request: Request) {
      const { amount, priceSlug, subscriptionId, transactionId } = await request.json()
      const customerExternalId = await getUserIdFromRequest(request)

      const usageEvent = await flowglad(customerExternalId).createUsageEvent({
        amount, priceSlug, subscriptionId, transactionId,
      })

      return NextResponse.json({ usageEvent })
    }

Remove any mock logic that simply echoes back the request or stores usage locally.

---

### 10. UI Components That Consume Billing

Make sure all billing-aware UI components are updated to use Flowglad:

- `app/pricing/page.tsx` (or equivalent pricing UI)
  - Import `useBilling` from `@flowglad/nextjs`.
  - Use `billing.pricingModel.products` to derive subscription plans (filter out default/free products, build `PricingPlan` objects).
- `components/navbar.tsx` (or equivalent account menu)
  - Import `useBilling` from `@flowglad/nextjs`.
  - Use `billing.currentSubscriptions?.[0]` to derive the active subscription.
  - Use `billing.cancelSubscription` to schedule cancellations and show cancellation state.
- `app/dashboard/page.tsx` (or equivalent dashboard)
  - Import `useBilling` from `@flowglad/nextjs`.
  - Use `billing.checkUsageBalance`, `billing.checkFeatureAccess`, `billing.getPrice`, `billing.createCheckoutSession`, and `billing.reload` to:
    - Gate access to primary features by plan.
    - Show remaining vs total usage for each meter.
    - Start checkouts for top‑ups or plan upgrades.
  - Do **not** manually mutate balances; rely on Flowglad usage events + reload.

If the startup repo did not previously have any billing UI, you may create a minimal pricing page and basic usage meters that follow this pattern.

---

### 11. Environment Variables

Ensure the target project has the Flowglad environment variable configured:

- `.env.local` should include:

    FLOWGLAD_SECRET_KEY=sk_test_or_live_from_flowglad

Do **not** hard-code secrets in code; only reference `process.env.FLOWGLAD_SECRET_KEY` where required by Flowglad packages (usually inside the Flowglad SDK configuration, not directly in your app code).

---

### 12. Final Checklist (What You Must Achieve)

When you are done, the project should:

- **Compile and type-check** successfully - verify this by running the project's compilation / lint / typechecking step.
- **Run** with:
  - Working authentication (BetterAuth or equivalent).
  - Flowglad billing:
    - Pricing page shows plans derived from the Flowglad pricing model (based on the `pricing.yaml` included here).
    - Authenticated users are mapped to Flowglad customers.
    - Usage meters (`fast_generations`, `hd_video_minutes`) are driven by Flowglad.
    - Top‑ups and usage events are created through Flowglad, not local mocks.
- Have **no leftover mock billing code**: no `localStorage`-based balances, no hard-coded plan entitlements, no unused billing implementations.

Apply all necessary edits in one pass so that the resulting project is fully Flowglad‑integrated without requiring additional manual fixes.
```
</Accordion>