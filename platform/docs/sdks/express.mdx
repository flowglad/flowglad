---
title: "Express Integration"
description: "Express middleware and route handlers for Flowglad integration"
---

import ExpressSetup from '/snippets/setup-express.mdx'

<Warning>
  **Deprecated Package**: The `@flowglad/express` package is deprecated.
  Use `@flowglad/server/express` instead. See [migration guide](#migration-from-flowgladexpress) below.
</Warning>

<Info>
  Express utilities are available via [@flowglad/server](https://www.npmjs.com/package/@flowglad/server) using the `/express` subpath export.
</Info>

## Overview

The Express integration provides middleware and route handlers for integrating Flowglad into your Express.js applications. It works seamlessly with the Flowglad Server SDK to handle billing operations.

<ExpressSetup />

## Key Features

- **Express Router**: Pre-configured router for easy mounting
- **Route Handler**: Flexible handler for custom routing
- **Request Context**: Automatic customer context from requests
- **Error Handling**: Built-in error handling for billing operations
- **Type Safety**: Full TypeScript support

## API Reference

### createFlowgladExpressRouter

Creates an Express router with all Flowglad routes pre-configured.

#### Parameters

```typescript
interface CreateFlowgladExpressRouterOptions {
  flowgladServerConstructor: (
    req: Request
  ) => Promise<FlowgladServer> | FlowgladServer
  middleware?: RequestHandler[]
  beforeRequest?: () => Promise<void>
  afterRequest?: () => Promise<void>
  onError?: (error: unknown) => void
}
```

#### Returns

- `Router` - An Express router instance

#### Example

```ts
import express, { type Request } from 'express'
import { createFlowgladExpressRouter } from '@flowglad/server/express'
import { FlowgladServer } from '@flowglad/server'
import { requireAuth } from './middleware/auth'

const app = express()

const flowglad = (customerExternalId: string) => {
  // customerExternalId is the ID from YOUR app's database, NOT Flowglad's customer ID
  return new FlowgladServer({
    customerExternalId,
    getCustomerDetails: async (externalId) => {
      const user = await db.users.findOne({ id: externalId })
      return {
        email: user.email,
        name: user.name,
      }
    },
  })
}

const flowgladServerConstructor = (req: Request) => {
  // Extract customerExternalId from your auth/session
  // This should be YOUR app's user/organization ID, NOT Flowglad's customer ID
  const user = req.user as { id: string } | null
  if (!user) {
    throw new Error('User not authenticated')
  }
  return flowglad(user.id)
}

// Mount at /api/flowglad
app.use(
  '/api/flowglad',
  createFlowgladExpressRouter({
    middleware: [requireAuth],
    flowgladServerConstructor,
  })
)

// Or mount at a different path
app.use(
  '/billing',
  createFlowgladExpressRouter({ flowgladServerConstructor })
)
```

### createExpressRouteHandler

Creates a route handler function for custom routing setups.

#### Parameters

```typescript
interface CreateFlowgladExpressRouteHandlerOptions {
  flowgladServer: FlowgladServer
  beforeRequest?: () => Promise<void>
  afterRequest?: () => Promise<void>
  onError?: (error: unknown) => void
}
```

#### Returns

- `RequestHandler` - An Express request handler

#### Example

```ts
import express from 'express'
import { createExpressRouteHandler } from '@flowglad/server/express'
import { FlowgladServer } from '@flowglad/server'

const app = express()

const flowgladServer = new FlowgladServer({ /* ... */ })
const flowgladHandler = createExpressRouteHandler({ flowgladServer })

// Handle all HTTP methods
app.all('/api/flowglad/*', flowgladHandler)

// Or handle specific methods
app.get('/api/flowglad/*', flowgladHandler)
app.post('/api/flowglad/*', flowgladHandler)
```

## Integration with Authentication

### Passport.js Example

```ts src/lib/flowglad.ts
import { FlowgladServer } from '@flowglad/server'
import type { Request } from 'express'

const flowglad = (customerExternalId: string) => {
  // customerExternalId is the ID from YOUR app's database, NOT Flowglad's customer ID
  return new FlowgladServer({
    customerExternalId,
    getCustomerDetails: async (externalId) => {
      const user = await db.users.findOne({ id: externalId })
      return {
        email: user.email,
        name: user.name,
      }
    },
  })
}

export const flowgladServerConstructor = (req: Request) => {
  // Extract customerExternalId from your auth/session
  // This should be YOUR app's user/organization ID, NOT Flowglad's customer ID
  const user = req.user as { id: string } | undefined
  if (!user) {
    throw new Error('User not authenticated')
  }
  return flowglad(user.id)
}
```

### JWT Auth Example

```ts src/lib/flowglad.ts
import { FlowgladServer } from '@flowglad/server'
import type { Request } from 'express'
import jwt from 'jsonwebtoken'

const flowglad = (customerExternalId: string) => {
  // customerExternalId is the ID from YOUR app's database, NOT Flowglad's customer ID
  return new FlowgladServer({
    customerExternalId,
    getCustomerDetails: async (externalId) => {
      const user = await db.users.findOne({ id: externalId })
      return {
        email: user.email,
        name: user.name,
      }
    },
  })
}

export const flowgladServerConstructor = (req: Request) => {
  // Extract customerExternalId from your auth/session
  // This should be YOUR app's user/organization ID, NOT Flowglad's customer ID
  const token = req.headers.authorization?.replace('Bearer ', '')
  if (!token) {
    throw new Error('User not authenticated')
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!) as {
      userId: string
    }
    return flowglad(decoded.userId)
  } catch (error) {
    throw new Error('Invalid token')
  }
}
```

### Session-Based Auth Example

```ts src/lib/flowglad.ts
import { FlowgladServer } from '@flowglad/server'
import type { Request } from 'express'

const flowglad = (customerExternalId: string) => {
  // customerExternalId is the ID from YOUR app's database, NOT Flowglad's customer ID
  return new FlowgladServer({
    customerExternalId,
    getCustomerDetails: async (externalId) => {
      const user = await db.users.findOne({ id: externalId })
      return {
        email: user.email,
        name: user.name,
      }
    },
  })
}

export const flowgladServerConstructor = (req: Request) => {
  // Extract customerExternalId from your auth/session
  // This should be YOUR app's user/organization ID, NOT Flowglad's customer ID
  if (!req.session?.userId) {
    throw new Error('User not authenticated')
  }
  return flowglad(req.session.userId)
}
```

## Complete Example

Here's a full Express application with Flowglad integration:

```ts src/index.ts
import express, { type Request } from 'express'
import session from 'express-session'
import { createFlowgladExpressRouter } from '@flowglad/server/express'
import { FlowgladServer } from '@flowglad/server'

const app = express()

// Middleware
app.use(express.json())
app.use(
  session({
    secret: process.env.SESSION_SECRET!,
    resave: false,
    saveUninitialized: false,
  })
)

// Create Flowglad server factory function
const flowglad = (customerExternalId: string) => {
  // customerExternalId is the ID from YOUR app's database, NOT Flowglad's customer ID
  return new FlowgladServer({
    customerExternalId,
    getCustomerDetails: async (externalId) => {
      const user = await db.users.findOne({ id: externalId })
      return {
        email: user.email,
        name: user.name,
      }
    },
  })
}

// Create Flowglad server constructor
const flowgladServerConstructor = (req: Request) => {
  // Extract customerExternalId from your auth/session
  // This should be YOUR app's user/organization ID, NOT Flowglad's customer ID
  if (!req.session?.userId) {
    throw new Error('User not authenticated')
  }
  return flowglad(req.session.userId)
}

// Mount Flowglad routes
app.use(
  '/api/flowglad',
  createFlowgladExpressRouter({ flowgladServerConstructor })
)

// Your other routes
app.get('/api/health', (req, res) => {
  res.json({ status: 'ok' })
})

const PORT = process.env.PORT || 3000
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`)
})
```

## Middleware Configuration

### CORS

If you need CORS support, add it before the Flowglad routes:

```ts
import cors from 'cors'

app.use(
  '/api/flowglad',
  cors({
    origin: process.env.FRONTEND_URL,
    credentials: true,
  })
)

app.use(
  '/api/flowglad',
  createFlowgladExpressRouter({ flowgladServerConstructor })
)
```

### Custom Middleware

Add custom middleware before the Flowglad routes:

```ts
import { requireAuth } from './middleware/auth'

// Protect Flowglad routes with authentication
app.use('/api/flowglad', requireAuth)
app.use(
  '/api/flowglad',
  createFlowgladExpressRouter({ flowgladServerConstructor })
)
```

## Error Handling

The Express SDK includes built-in error handling, but you can add custom error handlers:

```ts
app.use(
  '/api/flowglad',
  createFlowgladExpressRouter({ flowgladServerConstructor })
)

// Custom error handler
app.use((err, req, res, next) => {
  console.error('Flowglad error:', err)
  res.status(500).json({
    error: 'Internal server error',
    message: process.env.NODE_ENV === 'development' ? err.message : undefined,
  })
})
```

## Example Project

For a complete working example, see our [Express playground project](https://github.com/flowglad/flowglad/tree/main/playground/express).

## Migration from @flowglad/express

The `@flowglad/express` package is deprecated. All Express utilities are now available via `@flowglad/server/express`.

### Installation

**Before:**
```bash
npm install @flowglad/express
```

**After:**
```bash
npm install @flowglad/server express
```

### Import Changes

**Before:**
```ts
import { createFlowgladExpressRouter, FlowgladServer } from '@flowglad/express'
```

**After:**
```ts
import { createFlowgladExpressRouter } from '@flowglad/server/express'
import { FlowgladServer } from '@flowglad/server'
```

### API Compatibility

The API is fully compatible. No changes are required to your route handlers or middleware configuration - just update the import paths.

## Next Steps

<CardGroup cols={2}>
  <Card title="Server SDK" icon="server" href="/sdks/server">
    Learn about server-side capabilities
  </Card>
  <Card title="Examples" icon="code" href="/sdks/examples">
    Browse more code examples
  </Card>
</CardGroup>

