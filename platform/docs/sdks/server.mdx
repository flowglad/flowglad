---
title: "@flowglad/server"
description: "Core server-side SDK for Flowglad integration in Node.js applications"
---

import ServerSetup from '/snippets/setup-server.mdx'

<Info>
  NPM Package: [@flowglad/server](https://www.npmjs.com/package/@flowglad/server)
</Info>

## Overview

The Server SDK is the core package for server-side Flowglad integration. It provides the `FlowgladServer` class that handles all billing operations, customer management, and API communication with Flowglad.

## Installation

<CodeGroup>

```bash npm
npm install @flowglad/server
```

```bash yarn
yarn add @flowglad/server
```

```bash bun
bun add @flowglad/server
```

</CodeGroup>

<ServerSetup />

## Key Features

- **Customer Management**: Find or create customers automatically
- **Subscriptions**: Create, update, and cancel subscriptions
- **Checkout Sessions**: Generate checkout URLs for payments
- **Feature Access**: Check customer access to features
- **Usage Tracking**: Record usage events for metered billing
- **Invoices**: Retrieve and manage invoices
- **Payment Methods**: Handle customer payment methods
- **Pricing Model**: Access your pricing model with products, prices, and features

## API Reference

### Constructor

```typescript
new FlowgladServer(options: FlowgladServerOptions)
```

#### Options

```typescript
interface FlowgladServerOptions {
  apiKey?: string // Defaults to FLOWGLAD_SECRET_KEY env var
  baseURL?: string // Defaults to https://app.flowglad.com
  getRequestingCustomer: () => Promise<CustomerInfo | null>
}

interface CustomerInfo {
  externalId: string
  name: string
  email: string
  metadata?: Record<string, any>
}
```

### Customer Methods

#### `getRequestingCustomerId()`

Get the ID of the current customer.

```typescript
const customerId = await flowgladServer.getRequestingCustomerId()
```

#### `findOrCreateCustomer()`

Find an existing customer or create a new one.

```typescript
const customer = await flowgladServer.findOrCreateCustomer()
```

#### `getSession()`

Get the requesting customer's identity (externalId, name, email) derived from your auth integration.

```typescript
const session = await flowgladServer.getSession()
```

### Billing Methods

#### `getBilling()`

Get comprehensive billing information for the customer, including helper functions like `checkFeatureAccess`, `checkUsageBalance`, `getProduct`, and `getPrice`.

```typescript
const billing = await flowgladServer.getBilling()
const hasPremium = billing.checkFeatureAccess('premium_feature')
const invoiceCount = billing.invoices.length
```

#### `getPricingModel()`

Get the default pricing model with products, prices, and features.

```typescript
const pricingModel = await flowgladServer.getPricingModel()
// Returns products, prices, and features available for purchase
```

### Subscription Methods

#### `createSubscription`

Create a new subscription for the customer.

```typescript
const subscription = await flowgladServer.createSubscription({
  priceId: 'price_123',
  quantity: 1,
  metadata: {
    source: 'upgrade_flow',
  },
})
```

**Parameters:**

```typescript
interface CreateSubscriptionParams {
  priceId: string
  quantity?: number
  metadata?: Record<string, string>
}
```

#### `cancelSubscription`

Cancel an existing subscription.

```typescript
const canceledSubscription = await flowgladServer.cancelSubscription({
  id: 'sub_123',
  cancellation: {
    timing: 'at_end_of_current_billing_period',
  },
})
```

**Parameters:**

```typescript
interface CancelSubscriptionParams {
  id: string
  cancellation:
    | { timing: 'at_end_of_current_billing_period' }
    | { timing: 'at_future_date'; endDate: Date }
    | { timing: 'immediately' }
}
```

### Checkout Methods

#### `createCheckoutSession`

Create a checkout session for payments.

```typescript
const checkoutSession = await flowgladServer.createCheckoutSession({
  type: 'subscription', // or 'one_time'
  priceId: 'price_123',
  successUrl: 'https://example.com/success',
  cancelUrl: 'https://example.com/cancel',
  quantity: 1,
  metadata: {
    campaign: 'summer_sale',
  },
})

// Redirect user to checkoutSession.url
```

**Parameters:**

```typescript
interface CreateCheckoutSessionParams {
  priceId: string
  successUrl: string
  cancelUrl: string
  quantity?: number
  outputMetadata?: Record<string, unknown>
  outputName?: string
}
```

#### `createAddPaymentMethodCheckoutSession`

Create a checkout session that collects a payment method for the current customer.

```typescript
const session = await flowgladServer.createAddPaymentMethodCheckoutSession({
  successUrl: 'https://example.com/payment-methods/success',
  cancelUrl: 'https://example.com/payment-methods/cancel',
  targetSubscriptionId: 'sub_123', // optional
})
```

#### `createActivateSubscriptionCheckoutSession`

Create a checkout session that activates a provisioning or imported subscription.

```typescript
const activationSession =
  await flowgladServer.createActivateSubscriptionCheckoutSession({
    targetSubscriptionId: 'sub_123',
    priceId: 'price_123',
    successUrl: 'https://example.com/subscriptions/success',
    cancelUrl: 'https://example.com/subscriptions/cancel',
  })
```

### Customer Updates

#### `updateCustomer`

Update the stored customer record in Flowglad.

```typescript
await flowgladServer.updateCustomer({
  customer: {
    id: 'cust_abc',
    name: 'New Name',
    email: 'new-email@example.com',
  },
})
```

### Feature Access Methods

#### `checkFeatureAccess`

Check if the customer has access to a specific feature.

```typescript
const hasAccess = await flowgladServer.checkFeatureAccess('advanced_analytics')

if (hasAccess) {
  // Grant access to feature
}
```

### Usage Tracking Methods

#### `createUsageEvent`

Record a usage event for metered billing.

```typescript
const usageEvent = await flowgladServer.createUsageEvent({
  amount: 125,
  priceId: 'price_usage_meter',
  subscriptionId: 'sub_123',
  usageMeterId: 'usage_meter_api_calls',
  transactionId: 'txn_unique',
  usageDate: Date.now(),
  properties: {
    endpoint: '/api/data',
  },
})
```

**Parameters:**

```typescript
interface CreateUsageEventParams {
  amount: number
  priceId: string
  subscriptionId: string
  usageMeterId: string
  transactionId: string
  usageDate?: number
  properties?: Record<string, unknown>
}
```

## Common Patterns

### Feature Gating Middleware

```typescript
import { FlowgladServer } from '@flowglad/server'

export function requireFeature(featureId: string) {
  return async (req, res, next) => {
    const billing = await flowgladServer.getBilling()
    const hasAccess = billing.checkFeatureAccess(featureId)

    if (!hasAccess) {
      return res.status(403).json({
        error: 'Feature not available',
        message: 'Please upgrade your plan to access this feature',
      })
    }

    next()
  }
}

// Usage
app.get('/api/premium-endpoint', requireFeature('premium_feature'), (req, res) => {
  res.json({ data: 'premium data' })
})
```

### Usage Metering

```typescript
export async function trackAPIUsage(endpoint: string) {
  await flowgladServer.createUsageEvent({
    priceId: 'price_usage_api_calls',
    usageMeterId: 'usage_meter_api_calls',
    subscriptionId: 'sub_current',
    amount: 1,
    properties: {
      endpoint,
    },
  })
}

// Usage
app.get('/api/data', async (req, res) => {
  await trackAPIUsage('/api/data')
  res.json({ data: 'response' })
})
```

### Subscription Upgrade Flow

```typescript
export async function upgradeSubscription(
  currentSubscriptionId: string,
  newPriceId: string
) {
  try {
    // Cancel current subscription
    await flowgladServer.cancelSubscription({
      id: currentSubscriptionId,
      cancellation: {
        timing: 'immediately',
      },
    })

    // Create new subscription
    const newSubscription = await flowgladServer.createSubscription({
      priceId: newPriceId,
    })

    return newSubscription
  } catch (error) {
    console.error('Upgrade failed:', error)
    throw error
  }
}
```

### Customer Portal Generation

```typescript
export async function getCustomerPortalData() {
  const billing = await flowgladServer.getBilling()

  return {
    customer: billing.customer,
    activeSubscriptions: billing.subscriptions.filter(
      (s) => s.status === 'active'
    ),
    paymentMethods: billing.paymentMethods,
    recentInvoices: billing.invoices.slice(0, 10),
    features: billing.features,
  }
}
```

## Integration Examples

<Info>
Native constructor params are available for popular auth providers including Supabase Auth, Clerk, Next Auth. Read more about auth adaptors [here](/sdks/auth-adaptors)
</Info>

### With Supabase Auth

```typescript
import { FlowgladServer } from '@flowglad/server'
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_KEY!
)

export const flowgladServer = new FlowgladServer({
  getRequestingCustomer: async () => {
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) return null

    return {
      externalId: user.id,
      name: user.user_metadata.full_name || user.email!,
      email: user.email!,
    }
  },
})
```

### With Firebase Auth

```typescript
import { FlowgladServer } from '@flowglad/server'
import admin from 'firebase-admin'

admin.initializeApp()

export const flowgladServer = new FlowgladServer({
  getRequestingCustomer: async (context) => {
    const token = context?.req?.headers.authorization?.replace('Bearer ', '')

    if (!token) return null

    try {
      const decodedToken = await admin.auth().verifyIdToken(token)

      return {
        externalId: decodedToken.uid,
        name: decodedToken.name || decodedToken.email!,
        email: decodedToken.email!,
      }
    } catch (error) {
      return null
    }
  },
})
```

### With Clerk

```typescript
import { FlowgladServer } from '@flowglad/server'
import { clerkClient } from '@clerk/clerk-sdk-node'

export const flowgladServer = new FlowgladServer({
  getRequestingCustomer: async (context) => {
    const sessionId = context?.req?.cookies.get('__session')

    if (!sessionId) return null

    try {
      const session = await clerkClient.sessions.getSession(sessionId)
      const user = await clerkClient.users.getUser(session.userId)

      return {
        externalId: user.id,
        name: `${user.firstName} ${user.lastName}`,
        email: user.emailAddresses[0].emailAddress,
      }
    } catch (error) {
      return null
    }
  },
})
```

## Error Handling

The SDK throws errors that you should handle appropriately:

```typescript
try {
  const subscription = await flowgladServer.createSubscription({
    priceId: 'price_123',
  })
} catch (error) {
  if (error.code === 'CUSTOMER_NOT_FOUND') {
    // Handle customer not found
  } else if (error.code === 'PAYMENT_REQUIRED') {
    // Handle payment required
  } else {
    // Handle other errors
    console.error('Unexpected error:', error)
  }
}
```

## Next Steps

<CardGroup cols={2}>
  <Card title="Next.js SDK" icon="react" href="/sdks/nextjs">
    Use with Next.js applications
  </Card>
  <Card title="Express SDK" icon="node" href="/sdks/express">
    Use with Express applications
  </Card>
</CardGroup>

