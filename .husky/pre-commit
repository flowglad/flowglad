#!/bin/sh

# Add bun to PATH (git hooks run in minimal environment)
export PATH="$HOME/.bun/bin:$PATH"

# Resolve the repository root directory (works from any subdirectory)
ROOT_DIR=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -z "$ROOT_DIR" ]; then
  echo "âŒ Could not resolve git repository root"
  exit 1
fi
 
# Format staged TypeScript files with Prettier (only staged .ts/.tsx files)
STAGED_TS_FILES_NUL=$(mktemp)
git diff --cached --name-only -z --diff-filter=ACMR -- '*.ts' '*.tsx' > "$STAGED_TS_FILES_NUL"

if [ -s "$STAGED_TS_FILES_NUL" ]; then
  echo "ðŸª„ Running Prettier on staged TypeScript files..."
  xargs -0 bunx prettier --write < "$STAGED_TS_FILES_NUL"
  PRETTIER_STATUS=$?
  if [ $PRETTIER_STATUS -ne 0 ]; then
    echo "âŒ Prettier formatting failed. Please fix errors before committing."
    rm -f "$STAGED_TS_FILES_NUL"
    exit 1
  fi
  # Restage formatted files
  xargs -0 git add < "$STAGED_TS_FILES_NUL"
fi
rm -f "$STAGED_TS_FILES_NUL"

# Run linting and typechecking in parallel for all packages
bun run --if-present --filter @flowglad/* check &
PID1=$!

# Run linting and typechecking for platform/flowglad-next
cd "$ROOT_DIR/platform/flowglad-next" && bun run check &
PID2=$!

# Wait for each process and capture exit status
wait $PID1
STATUS1=$?

wait $PID2
STATUS2=$?

# Check if any lint or typechecking task failed
if [ $STATUS1 -ne 0 ] || [ $STATUS2 -ne 0 ]; then
  echo "âŒ Lint or typechecking checks failed. Please fix errors before committing."
  exit 1
fi

echo "âœ… All lint and typechecking checks passed!"
