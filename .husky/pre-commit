#!/bin/sh

# Add bun to PATH (git hooks run in minimal environment)
export PATH="$HOME/.bun/bin:$PATH"

# Resolve the repository root directory (works from any subdirectory)
ROOT_DIR=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -z "$ROOT_DIR" ]; then
  echo "âŒ Could not resolve git repository root"
  exit 1
fi

# Run Biome check (format + lint) on staged files only
STAGED_TS_FILES_NUL=$(mktemp)
git diff --cached --name-only -z --diff-filter=ACMR -- '*.ts' '*.tsx' '*.json' > "$STAGED_TS_FILES_NUL"

if [ -s "$STAGED_TS_FILES_NUL" ]; then
  echo "ðŸª„ Running Biome (format + lint) on staged files..."
  xargs -0 bunx @biomejs/biome check --write -- < "$STAGED_TS_FILES_NUL"
  BIOME_STATUS=$?
  if [ $BIOME_STATUS -ne 0 ]; then
    echo "âŒ Biome check failed. Please fix errors before committing."
    rm -f "$STAGED_TS_FILES_NUL"
    exit 1
  fi
  # Restage files after formatting
  xargs -0 git add -- < "$STAGED_TS_FILES_NUL"
fi
rm -f "$STAGED_TS_FILES_NUL"

# Run TypeScript type checking in parallel
echo "ðŸ” Running TypeScript type checking..."

# Typecheck @flowglad/* packages via turbo
cd "$ROOT_DIR" && bunx turbo run typecheck &
PID1=$!

# Typecheck flowglad-next separately (not in turbo scope)
cd "$ROOT_DIR/platform/flowglad-next" && bun run typecheck &
PID2=$!

wait $PID1
STATUS1=$?

wait $PID2
STATUS2=$?

if [ $STATUS1 -ne 0 ] || [ $STATUS2 -ne 0 ]; then
  echo "âŒ TypeScript type checking failed. Please fix errors before committing."
  exit 1
fi

echo "âœ… All checks passed!"
