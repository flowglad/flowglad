name: Publish Packages and Create Release

# This workflow publishes packages to npm and creates a GitHub release after the
# version PR (created by version-pr.yml) is merged to main.
#
# Workflow:
# 1. Version PR from version-pr.yml is merged to main
# 2. This workflow detects the merged PR (by title or label)
# 3. Publishes all packages to npm using `bun run packages:publish`
# 4. Extracts version and changelog from the updated packages
# 5. Creates a GitHub release with tag v<version> and changelog content

on:
  # Trigger when any PR is closed (merged or closed)
  pull_request:
    types: [closed]
    branches:
      - main
  # Allow manual dispatch from GitHub UI with branch selection
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to publish from'
        required: true
        type: string
        default: 'main'

permissions:
  id-token: write # Required for OIDC
  contents: write

jobs:
  publish:
    # Only run if:
    # - Manual dispatch (workflow_dispatch), OR
    # - The PR was actually merged (not just closed) AND the PR title contains "chore: version packages" OR has "release" label
    # This ensures we only publish when the version PR is merged, not other PRs
    if: >
      github.event_name == 'workflow_dispatch' || (github.event.pull_request.merged == true && (contains(github.event.pull_request.title, 'chore: version packages') || contains(github.event.pull_request.labels.*.name, 'release')))
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
      # Determine the ref to checkout based on the event type
      # For workflow_dispatch: use the branch input (defaults to 'main' if empty)
      # For pull_request: use the merge commit SHA
      - name: Set checkout ref
        id: set_ref
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BRANCH="${{ github.event.inputs.branch }}"
            if [ -z "$BRANCH" ]; then
              BRANCH="main"
            fi
            echo "REF=$BRANCH" >> $GITHUB_ENV
          else
            echo "REF=${{ github.event.pull_request.merge_commit_sha }}" >> $GITHUB_ENV
          fi
      
      # Checkout the merge commit (not the PR head) to ensure we publish from the actual commit that landed on main
      # This prevents publishing from a different commit than what was merged
      # For manual dispatch, use the selected branch input
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ env.REF }}
          fetch-depth: 0

      # Setup Bun package manager (matches packageManager field in package.json)
      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2.1.0
        with:
          bun-version: '1.3.1'

      # Setup Node.js and configure npm registry authentication
      # NPM_TOKEN secret must be set in repository settings
      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm
        run: npm install -g npm@latest  # Ensures npm 11.5.1+
        
      # Install dependencies (needed to build packages before publishing)
      - name: Install dependencies
        run: bun install --no-progress

      # Publish all packages to npm
      # This command builds packages, publishes them, and cleans up changeset files
      - name: Publish packages
        run: bun run packages:publish

      # Extract version and changelog for the GitHub release
      # Since all SDK packages are versioned in lockstep, we can read from any package
      - name: Extract version and changelog
        id: release_info
        run: |
          # Get version from any package (they're all the same after changesets versioning)
          VERSION=$(find packages -name "package.json" -type f -not -path "*/node_modules/*" -exec grep -h '"version"' {} \; | head -1 | sed -E 's/.*"version":\s*"([^"]+)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Get changelog from first package found (all CHANGELOGs are identical)
          # Extract the latest version section (from first ## version header to next ##)
          CHANGELOG_FILE=$(find packages -name "CHANGELOG.md" -type f | head -1)
          if [ -n "$CHANGELOG_FILE" ]; then
            # Extract the latest version section (from first ## to next ##)
            CHANGELOG_BODY=$(awk '/^## / {if (p) exit; p=1} p' "$CHANGELOG_FILE" | sed '1d')
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG_BODY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      # Create a GitHub release with the version tag and changelog content
      # Tag format: v<version> (e.g., v0.13.0)
      # Pinned to specific commit SHA for security (prevents supply-chain attacks)
      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: "v${{ steps.release_info.outputs.version }}"
          name: "SDK Release v${{ steps.release_info.outputs.version }}"
          body: ${{ steps.release_info.outputs.changelog }}
          draft: false
          prerelease: false
          generate_release_notes: false
