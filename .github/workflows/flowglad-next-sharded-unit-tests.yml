# This workflow runs the unit tests
# for flowglad-next with bun test (backend) and vitest (frontend).
#
# Backend tests (.test.ts) run via bun test with file-based sharding.
# Frontend tests (.test.tsx) run via vitest with jsdom environment.
#
# Note: RLS tests run as part of test:integration in the merge queue only,
# since they require sequential execution due to shared database connection pools.
name: Flowglad Next Unit Tests

# This workflow is designed to be called by other workflows
# rather than triggered directly by events
on:
  workflow_call:

jobs:
  # Backend tests (.test.ts) run via bun test with file-based sharding
  # Each shard runs a subset of test files for better performance
  flowglad-next-backend-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]
      fail-fast: false

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s

    defaults:
      run:
        working-directory: platform/flowglad-next
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v3
        with:
          node-version: '18'
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.6'
      - name: Install dependencies
        run: bun run install-packages --no-progress
      - name: Run database migrations
        run: bun run migrations:push
        env:
          NODE_ENV: test
      - name: Run sharded backend tests (Shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
        run: |
          # Get sorted list of backend test files (exclude integration, RLS, and tsx files)
          files=$(find src -name "*.test.ts" ! -name "*.integration.test.ts" ! -name "*.rls.test.ts" | sort)
          total=$(echo "$files" | wc -l | tr -d ' ')

          # Calculate shard size and file range
          shard_size=$(( (total + ${{ matrix.shardTotal }} - 1) / ${{ matrix.shardTotal }} ))
          start=$(( (${{ matrix.shardIndex }} - 1) * shard_size + 1 ))
          end=$(( start + shard_size - 1 ))

          # Get files for this shard
          shard_files=$(echo "$files" | sed -n "${start},${end}p" | tr '\n' ' ')

          echo "Running shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }}: files $start to $end of $total"
          echo "Files: $shard_files"

          # Run bun test with the selected files
          if [ -n "$shard_files" ]; then
            bun test $shard_files
          else
            echo "No files to test in this shard"
          fi
        env:
          NODE_ENV: test
          CLAUDECODE: 1

  # Frontend tests (.test.tsx) run via vitest with jsdom environment
  # These are React component tests that need DOM APIs
  flowglad-next-frontend-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s

    defaults:
      run:
        working-directory: platform/flowglad-next
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v3
        with:
          node-version: '18'
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.6'
      - name: Install dependencies
        run: bun run install-packages --no-progress
      - name: Run database migrations
        run: bun run migrations:push
        env:
          NODE_ENV: test
      - name: Run frontend tests
        run: bun run test:frontend
        env:
          NODE_ENV: test

  # Summary job that waits for all test jobs to complete
  test-summary:
    if: ${{ !cancelled() }}
    needs: [flowglad-next-backend-tests, flowglad-next-frontend-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          echo "All test jobs completed"
          echo "Backend tests: ${{ needs.flowglad-next-backend-tests.result }}"
          echo "Frontend tests: ${{ needs.flowglad-next-frontend-tests.result }}"

          # Fail if any job failed
          if [ "${{ needs.flowglad-next-backend-tests.result }}" = "failure" ] || \
             [ "${{ needs.flowglad-next-frontend-tests.result }}" = "failure" ]; then
            echo "One or more test jobs failed"
            exit 1
          fi
