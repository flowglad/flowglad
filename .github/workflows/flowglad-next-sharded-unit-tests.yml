# This workflow runs the unit tests
# for flowglad-next with bun test (backend) and vitest (frontend).
#
# Backend tests run via bun test with file-based sharding:
# - Unit tests (*.unit.test.ts) use bun.unit.setup.ts
# - DB tests (*.db.test.ts) use bun.db.test.setup.ts
# Frontend tests (.test.tsx) run via vitest with jsdom environment.
#
# Note: RLS tests run as part of test:integration in the merge queue only,
# since they require sequential execution due to shared database connection pools.
name: Flowglad Next Unit Tests

# This workflow is designed to be called by other workflows
# rather than triggered directly by events
on:
  workflow_call:

jobs:
  # Backend tests (.test.ts) run via bun test with file-based sharding
  # Each shard runs a subset of test files for better performance
  flowglad-next-backend-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]
      fail-fast: false

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s

    defaults:
      run:
        working-directory: platform/flowglad-next
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v3
        with:
          node-version: '18'
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.6'
      - name: Install dependencies
        run: bun run install-packages --no-progress
      - name: Run database migrations
        run: bun run migrations:push
        env:
          NODE_ENV: test
      - name: Run sharded backend tests (Shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
        run: |
          # Get sorted list of unit test files
          unit_files=$(find src -name "*.unit.test.ts" | sort)
          unit_total=$(echo "$unit_files" | grep -c . || echo 0)

          # Get sorted list of db test files
          db_files=$(find src -name "*.db.test.ts" | sort)
          db_total=$(echo "$db_files" | grep -c . || echo 0)

          # Combine all files for sharding
          all_files=$(echo -e "$unit_files\n$db_files" | grep -v '^$' | sort)
          total=$(echo "$all_files" | grep -c . || echo 0)

          echo "Found $unit_total unit test files and $db_total db test files ($total total)"

          # Calculate shard size and file range
          shard_size=$(( (total + ${{ matrix.shardTotal }} - 1) / ${{ matrix.shardTotal }} ))
          start=$(( (${{ matrix.shardIndex }} - 1) * shard_size + 1 ))
          end=$(( start + shard_size - 1 ))

          # Get files for this shard
          shard_files=$(echo "$all_files" | sed -n "${start},${end}p")

          echo "Running shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }}: files $start to $end of $total"

          # Separate unit and db test files in this shard
          shard_unit_files=$(echo "$shard_files" | grep '\.unit\.test\.ts$' | tr '\n' ' ')
          shard_db_files=$(echo "$shard_files" | grep '\.db\.test\.ts$' | tr '\n' ' ')

          # Run unit tests with unit setup
          if [ -n "$shard_unit_files" ]; then
            echo "Running unit tests: $shard_unit_files"
            echo "$shard_unit_files" | xargs bun test --preload ./bun.unit.setup.ts
          fi

          # Run db tests with db setup
          if [ -n "$shard_db_files" ]; then
            echo "Running db tests: $shard_db_files"
            echo "$shard_db_files" | xargs bun test --preload ./bun.db.test.setup.ts
          fi

          # Check if any tests were run
          if [ -z "$shard_unit_files" ] && [ -z "$shard_db_files" ]; then
            echo "No files to test in this shard"
          fi
        env:
          NODE_ENV: test
          CLAUDECODE: 1

  # Frontend tests (.test.tsx) run via vitest with jsdom environment
  # These are React component tests that need DOM APIs
  flowglad-next-frontend-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s

    defaults:
      run:
        working-directory: platform/flowglad-next
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v3
        with:
          node-version: '18'
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.6'
      - name: Install dependencies
        run: bun run install-packages --no-progress
      - name: Run database migrations
        run: bun run migrations:push
        env:
          NODE_ENV: test
      - name: Run frontend tests
        run: bun run test:frontend
        env:
          NODE_ENV: test

  # Summary job that waits for all test jobs to complete
  test-summary:
    if: ${{ !cancelled() }}
    needs: [flowglad-next-backend-tests, flowglad-next-frontend-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          echo "All test jobs completed"
          echo "Backend tests: ${{ needs.flowglad-next-backend-tests.result }}"
          echo "Frontend tests: ${{ needs.flowglad-next-frontend-tests.result }}"

          # Fail if any job failed
          if [ "${{ needs.flowglad-next-backend-tests.result }}" = "failure" ] || \
             [ "${{ needs.flowglad-next-frontend-tests.result }}" = "failure" ]; then
            echo "One or more test jobs failed"
            exit 1
          fi
