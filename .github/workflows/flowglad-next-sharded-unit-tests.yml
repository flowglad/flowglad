# This workflow runs the unit tests
# for flowglad-next in a sharded manner.
# It runs the bun test command across 4 shards,
# and then merges the reports together.
#
# RLS (Row Level Security) tests are run separately with fileParallelism disabled
# because they share database connection pools and set session-level PostgreSQL
# settings that can interfere with each other when run in parallel.
name: Flowglad Next Unit Tests

# This workflow is designed to be called by other workflows
# rather than triggered directly by events
on:
  workflow_call:

jobs:
  # RLS tests must run separately with fileParallelism: false
  # to prevent database connection pool interference between test files.
  # These tests set session-level PostgreSQL settings (RLS context) that can
  # leak across pooled connections when tests run in parallel.
  flowglad-next-rls-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s
    defaults:
      run:
        working-directory: platform/flowglad-next
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v3
        with:
          node-version: '18'
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.14'
      - name: Install dependencies
        run: bun run install-packages --no-progress
      - name: Run database migrations
        run: bun run migrations:push
        env:
          NODE_ENV: test
      - name: Run RLS tests (sequential file execution)
        run: bun run test:rls
        env:
          NODE_ENV: test

  # Main job that runs tests across multiple shards in parallel
  # Each shard runs a subset of tests to improve performance
  # Note: RLS tests are excluded here (via vitest.config.ts) and run in flowglad-next-rls-tests
  flowglad-next-sharded-tests:
    runs-on: ubuntu-latest
    # Matrix strategy creates 4 parallel jobs (shards)
    # Each shard gets a different shardIndex (1-4) but same shardTotal (4)
    strategy:
      matrix:
        shardIndex: [1, 2, 3, 4]  # Individual shard identifier
        shardTotal: [4]           # Total number of shards
      fail-fast: false            # Don't stop other shards if one fails

    # PostgreSQL service container - replaces docker-compose for reliability
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        # Health check ensures postgres is ready before steps run
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s

    defaults:
      run:
        working-directory: platform/flowglad-next
    steps:
      # Standard setup steps for each shard
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          # Use branch from input if provided, otherwise use current ref
          ref: ${{ github.event.inputs.branch || github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v3
        with:
          node-version: '18'
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.14'
      - name: Install dependencies
        run: bun run install-packages --no-progress
      # Run database migrations (service container is already healthy)
      - name: Run database migrations
        run: bun run migrations:push
        env:
          NODE_ENV: test
      - name: Create vitest reports directory
        run: mkdir -p .vitest-reports
      # Run tests for this specific shard
      # Each shard runs a subset of tests based on shardIndex/shardTotal
      # Verbose output will show detailed test results in the CI logs
      - name: Run sharded tests (Shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
        run: bunx vitest run --reporter=verbose --reporter=blob --outputFile=.vitest-reports/blob-${{ matrix.shardIndex }}.json --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} --no-silent
        env:
          NODE_ENV: test
      # Upload test results as artifacts for later merging
      - name: Upload blob report to GitHub Actions Artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: blob-report-${{ matrix.shardIndex }}
          path: platform/flowglad-next/.vitest-reports/blob-${{ matrix.shardIndex }}.json
          include-hidden-files: true
          retention-days: 1  # Short retention since we merge immediately

  # Merges the reports from the sharded tests into a single report.
  # This job runs after all shards complete and combines their results
  merge-reports:
    if: ${{ !cancelled() }}  # Only run if workflow wasn't cancelled
    needs: [flowglad-next-sharded-tests, flowglad-next-rls-tests]  # Wait for all test jobs to finish
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: platform/flowglad-next
    steps:
      # Setup steps for merge job (similar to shard setup)
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v3
        with:
          node-version: '18'
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.14'
      - name: Install dependencies
        run: bun run install-packages --no-progress
      # Download all shard reports from artifacts
      - name: Download blob reports from GitHub Actions Artifacts
        uses: actions/download-artifact@v7
        with:
          path: platform/flowglad-next/.vitest-reports
          pattern: blob-report-*  # Download all shard reports
          merge-multiple: true    # Merge into single directory
      # Combine all shard reports into a single comprehensive report
      - name: Merge reports
        run: bunx vitest run --merge-reports
