name: PR Review Slack Reply
on:
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    if: |
      github.event.review.user.type != 'Bot' &&
      github.event.review.user.login != github.event.pull_request.user.login &&
      contains(github.event.pull_request.labels.*.name, 'needs-review')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Post to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PULL_REQUEST_URL }}
          SLACK_GITHUB_MAPPING: ${{ secrets.SLACK_GITHUB_MAPPING }}
          STATE: ${{ github.event.review.state }}
          TITLE: ${{ github.event.pull_request.title }}
          URL: ${{ github.event.pull_request.html_url }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not set; skipping Slack notification."
            exit 0
          fi

          case "$STATE" in
            approved)
              EMOJI="ðŸŸ¢"
              STATUS_LABEL="Approved:"
              ;;
            changes_requested|commented)
              EMOJI="ðŸ”´"
              STATUS_LABEL="Needs Changes:"
              ;;
            *)
              EMOJI="ðŸ”´"
              STATUS_LABEL="Needs Changes:"
              ;;
          esac

          # Look up Slack ID for author (case-insensitive), fallback to GitHub username
          AUTHOR_LOWER=$(echo "$AUTHOR" | tr '[:upper:]' '[:lower:]')
          if [ -n "$SLACK_GITHUB_MAPPING" ]; then
            SLACK_ID=$(echo "$SLACK_GITHUB_MAPPING" | jq -r --arg author "$AUTHOR_LOWER" 'to_entries | map(select(.key | ascii_downcase == $author)) | .[0].value // empty')
          fi

          if [ -n "$SLACK_ID" ]; then
            MENTION="<@${SLACK_ID}>"
          else
            MENTION="$AUTHOR"
          fi

          PAYLOAD=$(jq -n --arg emoji "$EMOJI" --arg status "$STATUS_LABEL" --arg title "$TITLE" --arg url "$URL" --arg mention "$MENTION" '{
            blocks: [
              {
                type: "section",
                text: {
                  type: "mrkdwn",
                  text: ($emoji + " " + $status + " <" + $url + "|" + $title + "> " + $mention)
                }
              },
              { type: "divider" }
            ]
          }')
          curl -sS -f -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            || echo "Slack notification failed (non-blocking)"

      - name: Remove needs-review label on approval
        if: github.event.review.state == 'approved'
        uses: actions/github-script@v8
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name: 'needs-review'
              });
              console.log('Removed needs-review label');
            } catch (e) {
              // Label might not exist on this PR, that's fine
              console.log('Label removal skipped:', e.message);
            }

  all-jobs-succeed:
    runs-on: ubuntu-latest
    needs: [notify]
    if: always()
    steps:
      - name: Verify all jobs succeeded
        run: |
          if [ "${{ needs.notify.result }}" != "success" ] && [ "${{ needs.notify.result }}" != "skipped" ]; then
            exit 1
          fi
