name: Create Version PR

# This workflow automatically creates a PR with version bumps and changelog updates
# when changesets are detected. It runs whenever code is pushed to main (typically
# after a PR with changesets is merged), or can be manually triggered.
#
# Workflow:
# 1. Developer adds a changeset file (.changeset/*.md) and merges PR to main
# 2. This workflow runs and detects unversioned changesets
# 3. Runs `bun run packages:version` to bump versions and update CHANGELOGs
# 4. Creates/updates a PR titled "chore: version packages" with these changes
# 5. After that PR is merged, the publish-release.yml workflow publishes packages

on:
  # Trigger when code is pushed to main (e.g., after a PR with changesets is merged)
  push:
    branches:
      - main
  # Also allow manual triggering via GitHub Actions UI
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  version:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
      # Checkout the repository with full git history (needed for changesets)
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      # Setup Bun package manager (matches packageManager field in package.json)
      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2.1.0
        with:
          bun-version: '1.3.1'

      # Install all dependencies (needed to run changesets commands)
      - name: Install dependencies
        run: bun install --no-progress

      # Configure git user (required for changesets to create commits)
      # The changesets action needs git user info to make commits when creating the PR
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # The changesets action handles everything:
      # - Checks for unversioned changesets (exits early if none exist)
      # - Runs `bun run packages:version` to bump package versions and update CHANGELOGs
      # - Creates or updates a PR with the version changes
      # - Prevents duplicate PRs (will update existing PR if one already exists)
      # Pinned to specific commit SHA for security (prevents supply-chain attacks)
      - name: Create Release Pull Request
        uses: changesets/action@6a0a831ff30acef54f2c6aa1cbbc1096b066edaf # v1
        with:
          version: bun run packages:version
          commit: 'chore: version packages'
          title: 'chore: version packages'
          setupGitUser: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0

